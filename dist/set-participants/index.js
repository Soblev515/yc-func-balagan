import e from"ydb-sdk";import{z as n}from"zod";function o(e,n,o,t){return new(o||(o=Promise))((function(i,r){function s(e){try{a(t.next(e))}catch(e){r(e)}}function d(e){try{a(t.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(s,d)}a((t=t.apply(e,n||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const{Driver:t,TypedData:i,getCredentialsFromEnv:r,getLogger:s}=e,d=e=>i.createNativeObjects(e),a=e=>o(void 0,void 0,void 0,(function*(){const n=s({level:"debug"}),i=(()=>{const e=process.env.DB_ENDPOINT,n=process.env.DB_DATABASE,o=r();return new t({endpoint:e,database:n,authService:o})})();if(!(yield i.ready(1e4))){const e="Driver has not become ready in 10 seconds!";throw n.fatal(e),new Error(e)}const a=yield i.tableClient.withSession((n=>o(void 0,void 0,void 0,(function*(){var o;const t=yield n.prepareQuery(e);return(null!==(o=(yield n.executeQuery(t)).resultSets)&&void 0!==o?o:[]).map(d)}))));return i.destroy(),a})),u=n.object({event_id:n.string(),number:n.string(),is_found:n.boolean(),is_profile:n.boolean()}),l=function(e,n){return o(this,void 0,void 0,(function*(){const o=u.parse(n.getPayload());console.log(o);const t=atob(e.headers.Authorization.split(" ")[1]).split(":"),i=(r=t[0],s=t[1],`\n    DECLARE $login AS String;\n    DECLARE $password AS String;\n\n    $login = "${r}";\n    $password = "${s}";\n\n    SELECT user_id FROM auth \n    WHERE login = $login \n    AND password = $password\n`);var r,s;const d=yield a(i);console.log(d[0][0].user_id),console.log(d[0].user_id);const l=((e,{event_id:n,is_found:o})=>`\n    DECLARE $event_id AS String;\n    DECLARE $user_id AS String;\n    DECLARE $visible AS Bool;\n    $user_id = "${e}";\n    $event_id = "${n}";\n    $visible = ${o};\n    \n    UPSERT INTO participants (user_id, event_id, visible)\n    Values ($user_id, $event_id, $visible)\n`)(d[0][0].user_id,o);return yield a(l),{statusCode:200,body:"Ok"}}))};export{l as handler};
