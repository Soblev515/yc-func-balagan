import n from"ydb-sdk";import{z as e}from"zod";function t(n,e,t,i){return new(t||(t=Promise))((function(r,o){function s(n){try{u(i.next(n))}catch(n){o(n)}}function d(n){try{u(i.throw(n))}catch(n){o(n)}}function u(n){var e;n.done?r(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(s,d)}u((i=i.apply(n,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const{Driver:i,TypedData:r,getCredentialsFromEnv:o,getLogger:s}=n,d=n=>r.createNativeObjects(n),u=n=>t(void 0,void 0,void 0,(function*(){const e=s({level:"debug"}),r=(()=>{const n=process.env.DB_ENDPOINT,e=process.env.DB_DATABASE,t=o();return new i({endpoint:n,database:e,authService:t})})();if(!(yield r.ready(1e4))){const n="Driver has not become ready in 10 seconds!";throw e.fatal(n),new Error(n)}const u=yield r.tableClient.withSession((e=>t(void 0,void 0,void 0,(function*(){var t;const i=yield e.prepareQuery(n);return(null!==(t=(yield e.executeQuery(i)).resultSets)&&void 0!==t?t:[]).map(d)}))));return r.destroy(),u})),a=e.object({user_id:e.string().optional()}),c=function(n,e){return t(this,void 0,void 0,(function*(){const e=a.parse(n.queryStringParameters);if(""==e.user_id){console.log("k");const r=atob(n.headers.Authorization.split(" ")[1]).split(":"),o=(t=r[0],i=r[1],`\n    DECLARE $login AS String;\n    DECLARE $password AS String;\n\n    $login = "${t}";\n    $password = "${i}";\n\n    SELECT user_id FROM auth \n    WHERE login = $login \n    AND password = $password\n`),s=yield u(o);e.user_id=s[0][0].user_id}var t,i;const r=(({user_id:n})=>`\n    DECLARE $user_id AS String;\n\n    $user_id = "${n}";\n\n    SELECT * FROM \`users\` WHERE user_id = $user_id;\n`)(e),o=yield u(r),s=(({user_id:n})=>`\n    DECLARE $user_id AS String;\n\n    $user_id = "${n}";\n\n    SELECT e.* FROM \`community\` as e \n    Left Join \`user_community\` as ec\n    On e.community_id = ec.community_id\n    WHERE user_id = $user_id;\n`)(e),d=yield u(s);for(const n of d[0])n.image="https://storage.yandexcloud.net/balaganimg/community/"+n.community_id+".png";o[0][0].community={},o[0][0].community.data=d[0],o[0][0].community.count=d[0].length;const c=(({user_id:n})=>`\n    DECLARE $user_id AS String;\n\n    $user_id = "${n}";\n\n    SELECT u.* FROM \`event\` as u \n    Left Join \`participants\` as uc\n    On u.event_id = uc.event_id\n    WHERE user_id = $user_id;\n`)(e),g=yield u(c);console.log(d);for(const n of g[0])n.image="https://storage.yandexcloud.net/balaganimg/event/"+n.event_id+".png";o[0][0].events={},o[0][0].events.data=g[0],o[0][0].events.count=g[0].length;const l=(({user_id:n})=>`\n    DECLARE $user_id AS String;\n\n    $user_id = "${n}";\n\n    SELECT t.* FROM \`tag\` as t \n    Left Join \`user_tags\` as ct\n    On t.tag_id = ct.tag_id\n    WHERE user_id = $user_id;\n`)(e),E=yield u(l);return o[0][0].tags={},o[0][0].tags.data=E[0],o[0][0].tags.count=E[0].length,{statusCode:200,body:JSON.stringify(o[0][0])}}))};export{c as handler};
